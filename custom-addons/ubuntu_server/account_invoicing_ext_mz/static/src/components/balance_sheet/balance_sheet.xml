<?xml version="1.0" encoding="UTF-8"?>
<templates xml:space="preserve">
    
    <t t-name="account_invoicing_ext_mz.BalanceSheetReport">
        <div class="o_balance_sheet_report">
            <!-- Header with controls -->
            <div class="o_control_panel">
                <div class="o_control_panel_main">
                    <div class="o_control_panel_breadcrumbs">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item">Accounting</li>
                            <li class="breadcrumb-item active">Balance Sheet</li>
                        </ol>
                    </div>
                    
                    <div class="o_control_panel_actions">
                        <!-- Export Buttons -->
                        <button class="btn btn-primary" t-on-click="() => this.exportPDF()">
                            <i class="fa fa-file-pdf-o"/> PDF
                        </button>
                        <button class="btn btn-primary ms-2" t-on-click="() => this.exportExcel()">
                            <i class="fa fa-file-excel-o"/> XLSX
                        </button>
                        
                        <span class="ms-3 text-muted">Balance Sheet</span>
                        
                        <!-- Date Filter -->
                        <div class="btn-group ms-3">
                            <button class="btn btn-outline-secondary" disabled="">
                                <i class="fa fa-calendar"/> As of <t t-esc="state.date_to"/>
                            </button>
                            <button class="btn btn-outline-secondary dropdown-toggle dropdown-toggle-split" 
                                    data-bs-toggle="dropdown">
                                <span class="visually-hidden">Toggle Dropdown</span>
                            </button>
                            <div class="dropdown-menu p-3">
                                <label>Select Date:</label>
                                <input type="date" class="form-control" 
                                       t-att-value="state.date_to"
                                       t-on-change="(ev) => this.onDateChange('date_to', ev)"/>
                            </div>
                        </div>
                        
                        <!-- Comparison Toggle -->
                        <button class="btn btn-outline-secondary ms-2" 
                                t-attf-class="{{state.comparison ? 'active' : ''}}"
                                t-on-click="() => this.onComparisonToggle()">
                            <i class="fa fa-balance-scale"/> Comparison
                        </button>
                        
                        <!-- All Journals Dropdown -->
                        <div class="btn-group ms-2">
                            <button class="btn btn-outline-secondary dropdown-toggle" 
                                    data-bs-toggle="dropdown">
                                <i class="fa fa-book"/> 
                                <t t-if="state.allJournals">All Journals</t>
                                <t t-else="">
                                    <t t-esc="state.selectedJournalsCount"/> Journal<t t-if="state.selectedJournalsCount > 1">s</t>
                                </t>
                            </button>
                            <div class="dropdown-menu p-3" style="min-width: 250px;">
                                <h6 class="dropdown-header">Select Journals</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="journal_all"
                                           t-att-checked="state.allJournals"
                                           t-on-change="() => this.toggleAllJournals()"/>
                                    <label class="form-check-label" for="journal_all">
                                        <strong>All Journals</strong>
                                    </label>
                                </div>
                                <hr class="dropdown-divider"/>
                                <t t-foreach="state.journals" t-as="journal" t-key="journal.id">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox"
                                               t-att-id="'journal_' + journal.id"
                                               t-att-checked="state.filters.journals.includes(journal.id)"
                                               t-att-disabled="state.allJournals"
                                               t-on-change="(ev) => this.onJournalToggle(journal.id, ev)"/>
                                        <label class="form-check-label" 
                                               t-att-for="'journal_' + journal.id">
                                            <t t-esc="journal.code"/> - <t t-esc="journal.name"/>
                                        </label>
                                    </div>
                                </t>
                            </div>
                        </div>
                        
                        <!-- Analytic Toggle -->
                        <button class="btn btn-outline-secondary ms-2"
                                t-attf-class="{{state.showAnalytic ? 'active' : ''}}"
                                t-on-click="() => this.onAnalyticToggle()">
                            <i class="fa fa-bar-chart"/> Analytic
                        </button>
                        
                        <!-- Posted Entries Filter -->
                        <button class="btn btn-outline-secondary ms-2"
                                t-attf-class="{{state.onlyPosted ? 'active' : ''}}"
                                t-on-click="() => this.onPostedEntriesToggle()">
                            <i class="fa fa-check-square"/> Posted Entries
                        </button>
                        
                        <!-- In Filter Dropdown -->
                        <div class="btn-group ms-2">
                            <button class="btn btn-outline-secondary dropdown-toggle" 
                                    data-bs-toggle="dropdown">
                                In <i class="fa fa-filter"/>
                            </button>
                            <div class="dropdown-menu p-3" style="min-width: 200px;">
                                <h6 class="dropdown-header">Filter Options</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="filter_all"
                                           checked="checked"/>
                                    <label class="form-check-label" for="filter_all">
                                        All Items
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" 
                                           id="filter_zero"/>
                                    <label class="form-check-label" for="filter_zero">
                                        Hide Zero Balances
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Main Content Area -->
            <div class="o_content">
                <!-- Unposted entries warning -->
                <t t-if="state.hasUnposted">
                    <div class="alert alert-info d-flex align-items-center">
                        <span>There are <strong>unposted Journal Entries</strong> prior or included in this period.</span>
                    </div>
                </t>
                
                <!-- Loading State -->
                <t t-if="state.loading">
                    <div class="text-center p-5">
                        <i class="fa fa-spinner fa-spin fa-3x text-primary"/>
                        <p class="mt-3">Loading balance sheet...</p>
                    </div>
                </t>
                
                <!-- Error State -->
                <t t-elif="state.error">
                    <div class="alert alert-danger">
                        <i class="fa fa-exclamation-triangle"/> <t t-esc="state.error"/>
                    </div>
                </t>
                
                <!-- Balance Sheet Table -->
                <t t-elif="state.data">
                    <div class="o_balance_sheet_table">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th width="60%"></th>
                                    <th class="text-end" width="20%">
                                        As of <t t-esc="state.data.date"/>
                                    </th>
                                    <t t-if="state.comparison and state.data.comparison">
                                        <th class="text-end" width="20%">
                                            As of <t t-esc="state.data.comparison.date"/>
                                        </th>
                                    </t>
                                    <th width="5%"></th>
                                </tr>
                                <tr>
                                    <th></th>
                                    <th class="text-end">Balance</th>
                                    <t t-if="state.comparison">
                                        <th class="text-end">Balance</th>
                                    </t>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                <t t-foreach="this.getVisibleLines()" t-as="line" t-key="line.id">
                                    <tr t-att-class="this.getLineClass(line)" 
                                        t-att-data-line-id="line.id">
                                        <td>
                                            <!-- Indentation based on level -->
                                            <span t-attf-style="padding-left: {{line.level * 30}}px;">
                                                <!-- Expand/Collapse Button -->
                                                <t t-if="line.unfoldable">
                                                    <button class="btn btn-sm btn-link p-0 me-1"
                                                            t-on-click.stop="() => this.toggleLine(line.id)">
                                                        <i t-attf-class="fa fa-{{this.isExpanded(line.id) ? 'caret-down' : 'caret-right'}}"/>
                                                    </button>
                                                </t>
                                                <t t-else="">
                                                    <t t-if="line.level > 2">
                                                        <span class="ms-3"></span>
                                                    </t>
                                                </t>
                                                
                                                <!-- Line Name with proper styling for account codes -->
                                                <span t-attf-class="line-name {{line.is_total ? 'fw-bold' : ''}} {{line.level == 3 ? 'text-muted' : ''}}">
                                                    <t t-esc="line.name"/>
                                                </span>
                                            </span>
                                        </td>
                                        
                                        <!-- Current Balance -->
                                        <td class="text-end">
                                            <span t-attf-class="{{line.is_total ? 'fw-bold' : ''}} {{line.balance &lt; 0 ? 'text-danger' : ''}}">
                                                <t t-esc="this.formatCurrency(line.balance)"/>
                                            </span>
                                        </td>
                                        
                                        <!-- Comparison Balance -->
                                        <t t-if="state.comparison">
                                            <td class="text-end">
                                                <span t-attf-class="{{line.is_total ? 'fw-bold' : ''}}">
                                                    <t t-if="state.data.comparison and state.data.comparison.lines">
                                                        <t t-esc="this.formatCurrency(line.comparison_balance)"/>
                                                    </t>
                                                </span>
                                            </td>
                                        </t>
                                        
                                        <!-- Info/Action Column -->
                                        <td class="text-center">
                                            <t t-if="line.has_details or line.level == 3">
                                                <button class="btn btn-sm btn-link p-0" 
                                                        title="View details">
                                                    <i class="fa fa-info-circle text-muted"/>
                                                </button>
                                            </t>
                                        </td>
                                    </tr>
                                </t>
                            </tbody>
                        </table>
                    </div>
                </t>
            </div>
        </div>
    </t>
    
</templates>